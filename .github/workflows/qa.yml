name: Quality Assurance

on:
  push:
    branches: [main, feat/*]
  pull_request:
    branches: [main]

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    name: Lint and Format Check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Lua 5.2
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.2"

      - name: Install LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install luacheck
        run: luarocks install luacheck

      - name: Lint Lua files
        run: |
          echo "🔍 Linting Lua files..."
          luacheck list.lua recipe.lua technology.lua tests/ --globals data util defines game script --ignore 211 212
          echo "✅ Lua linting completed"

      - name: Check documentation files exist
        run: |
          echo "📚 Checking documentation..."
          test -f "docs/list-module.md" && echo "✅ List module docs found"
          test -f "docs/recipe-module.md" && echo "✅ Recipe module docs found"
          test -f "docs/technology-module.md" && echo "✅ Technology module docs found"
          test -f "README.md" && echo "✅ README found"
          test -f "changelog.txt" && echo "✅ Changelog found"
          echo "✅ Documentation check completed"

      - name: Validate JSON files
        run: |
          echo "🔧 Validating JSON files..."
          python3 -m json.tool info.json > /dev/null && echo "✅ info.json is valid"
          python3 -m json.tool .vscode/settings.json > /dev/null && echo "✅ VS Code settings valid"
          python3 -m json.tool .vscode/tasks.json > /dev/null && echo "✅ VS Code tasks valid"
          python3 -m json.tool .vscode/launch.json > /dev/null && echo "✅ VS Code launch valid"
          echo "✅ JSON validation completed"

  test-matrix:
    runs-on: ubuntu-latest
    name: Test Matrix
    strategy:
      matrix:
        lua-version: ["5.2", "5.4"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Lua ${{ matrix.lua-version }}
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: ${{ matrix.lua-version }}

      - name: Run All Tests
        run: |
          echo "🧪 Running tests with Lua ${{ matrix.lua-version }}"
          cd tests

          echo "Testing List Module..."
          lua test_list.lua

          echo "Testing Recipe Module..."
          lua test_recipe.lua

          echo "Testing Technology Module..."
          lua test_technology.lua

          echo "✅ All tests passed with Lua ${{ matrix.lua-version }}!"
