name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    name: Create Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Lua 5.2
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.2"

      - name: Run Tests Before Release
        run: |
          echo "ğŸ§ª Running full test suite before release..."
          cd tests
          lua test_list.lua
          lua test_recipe.lua
          lua test_technology.lua
          echo "âœ… All tests passed!"

      - name: Validate Version Consistency
        run: |
          echo "ğŸ” Checking version consistency..."

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Tag version: $VERSION"

          # Check info.json version
          INFO_VERSION=$(python3 -c "import json; print(json.load(open('info.json'))['version'])")
          echo "info.json version: $INFO_VERSION"

          if [ "$VERSION" != "$INFO_VERSION" ]; then
            echo "âŒ Version mismatch between tag ($VERSION) and info.json ($INFO_VERSION)"
            exit 1
          fi

          echo "âœ… Version consistency check passed"

      - name: Create Factorio Mod Package
        run: |
          echo "ğŸ“¦ Creating mod package..."

          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          MOD_DIR="khaoslib_$VERSION"

          # Create mod directory structure with proper versioned name
          mkdir -p "$MOD_DIR"

          # Copy mod files (exclude development files)
          cp *.lua "$MOD_DIR/" 2>/dev/null || true
          cp info.json "$MOD_DIR/"
          cp changelog.txt "$MOD_DIR/"
          cp LICENSE "$MOD_DIR/"
          cp README.md "$MOD_DIR/"

          # Copy thumbnail if it exists
          if [ -f "thumbnail.png" ]; then
            cp thumbnail.png "$MOD_DIR/"
            echo "âœ… Included thumbnail.png"
          fi

          # Copy docs directory if it exists
          if [ -d "docs" ]; then
            cp -r docs "$MOD_DIR/"
            echo "âœ… Included docs directory"
          fi

          # Create versioned zip file
          ZIP_NAME="khaoslib_$VERSION.zip"
          zip -r "$ZIP_NAME" "$MOD_DIR/"

          echo "âœ… Mod package created: $ZIP_NAME"

      - name: Verify Package Contents
        run: |
          echo "ğŸ” Verifying package contents..."

          VERSION=${GITHUB_REF#refs/tags/v}
          ZIP_NAME="khaoslib_$VERSION.zip"

          # List contents of the zip file
          echo "ğŸ“ Package contents:"
          unzip -l "$ZIP_NAME"

          # Verify essential files are present
          if unzip -l "$ZIP_NAME" | grep -q "info.json"; then
            echo "âœ… info.json included"
          else
            echo "âŒ info.json missing"
            exit 1
          fi

          if unzip -l "$ZIP_NAME" | grep -q "thumbnail.png"; then
            echo "âœ… thumbnail.png included"
          else
            echo "âš ï¸  thumbnail.png not found (optional)"
          fi

          if unzip -l "$ZIP_NAME" | grep -q "docs/"; then
            echo "âœ… docs directory included"
          else
            echo "âš ï¸  docs directory not found (optional)"
          fi

      - name: Extract Release Notes
        id: release_notes
        run: |
          echo "ğŸ“ Extracting release notes from changelog..."

          # Extract the latest version's changes from changelog.txt
          VERSION=${GITHUB_REF#refs/tags/v}

          # Extract base release notes and get line numbers
          awk "/Version: $VERSION/,/^---/" changelog.txt | \
            head -n -1 | tail -n +3 > raw_changelog.tmp

          # Find the starting line number of this version in the original file
          VERSION_LINE=$(grep -n "Version: $VERSION" changelog.txt | cut -d: -f1)
          START_LINE=$((VERSION_LINE + 2))  # Skip version line and date line

          echo "ğŸ“‹ Version starts at line $START_LINE in changelog.txt"

          # Process each line and add PR references using git blame
          line_num=$START_LINE
          > release_notes.md

          while IFS= read -r line; do
            if [[ $line == "  "[A-Z]*":" ]]; then
              # Category header
              category=$(echo "$line" | sed 's/^  \([A-Z][a-zA-Z]*\):$/### \1/')
              echo "$category" >> release_notes.md
            elif [[ $line == "    - "* ]]; then
              # Feature line - get ALL PR references that modified this line since last release
              feature_text="${line#    - }"

              # Get the previous release tag
              PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

              # Get all commits that modified this specific line since previous release
              if [ -n "$PREV_TAG" ]; then
                # Use git log -L to get line history since previous release
                line_commits=$(git log -L${line_num},${line_num}:changelog.txt --format="%H" ${PREV_TAG}..HEAD 2>/dev/null || echo "")
              else
                # For first release, get complete line history from beginning
                line_commits=$(git log -L${line_num},${line_num}:changelog.txt --format="%H" 2>/dev/null || echo "")
              fi

              # Collect all PR references from commits that modified this line
              pr_refs=""
              unique_prs=""

              for commit_hash in $line_commits; do
                if [ -n "$commit_hash" ]; then
                  # Get the commit message for this hash
                  commit_msg=$(git log --format=%s -n 1 "$commit_hash" 2>/dev/null || echo "")

                  # Extract PR number from commit message
                  pr_ref=$(echo "$commit_msg" | grep -oE '#[0-9]+' | head -1)

                  if [ -n "$pr_ref" ] && [[ ! "$unique_prs" =~ $pr_ref ]]; then
                    unique_prs="$unique_prs $pr_ref"
                    if [ -n "$pr_refs" ]; then
                      pr_refs="$pr_refs, $pr_ref"
                    else
                      pr_refs="$pr_ref"
                    fi
                    echo "  ğŸ“ Line $line_num -> $pr_ref (commit: ${commit_hash:0:7})"
                  fi
                fi
              done

              # Format the changelog entry with all PR references
              if [ -n "$pr_refs" ]; then
                echo "- $feature_text ($pr_refs)" >> release_notes.md
              else
                echo "- $feature_text" >> release_notes.md
              fi
            elif [[ -n "$line" ]]; then
              # Other non-empty lines
              echo "$line" >> release_notes.md
            else
              # Empty lines
              echo "" >> release_notes.md
            fi

            line_num=$((line_num + 1))
          done < raw_changelog.tmp

          # Clean up
          rm -f raw_changelog.tmp

          echo "âœ… Release notes prepared with git blame PR references"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: khaoslib_*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
